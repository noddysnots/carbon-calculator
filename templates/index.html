<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carbon Footprint Calculator (Sarthak Pant, IIM L)</title>
  
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet" />
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://unpkg.com/three-globe/dist/three-globe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts-gl/dist/echarts-gl.min.js"></script>

  <style>
    /* 3D Earth background, faded */
    #earth-bg {
      position: fixed;
      top: 0;
      left: 0;
      z-index: -1;
      opacity: 0.3;
      width: 100%;
      height: 100%;
    }
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow-x: hidden;
    }
    canvas {
      display: block;
      width: 100%;
      height: 100%;
    }
    #ghg-chart-container {
      width: 100%;
      height: 400px;
      margin-top: 2rem;
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }
    #ghg-chart-container:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }
    .card-hover {
      transition: all 0.3s ease;
    }
    .card-hover:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }
    .glass-effect {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    /* Simple ticker for news (optional) */
    #news-ticker {
      overflow: hidden;
      white-space: nowrap;
    }
    #news-ticker span {
      display: inline-block;
      padding-right: 2rem;
      animation: ticker 25s linear infinite;
    }
    @keyframes ticker {
      0% { transform: translateX(100%); }
      100% { transform: translateX(-100%); }
    }
  </style>
</head>

<body class="bg-gray-100">
  <canvas id="earth-bg"></canvas>

  <!-- HEADER -->
  <header class="bg-green-600 bg-opacity-95 text-white p-4 sticky top-0 z-50 shadow-lg">
    <div class="max-w-7xl mx-auto px-4 flex flex-col md:flex-row justify-between items-center">
      <h1 class="text-2xl font-bold mb-2 md:mb-0" data-aos="fade-right">
        Carbon Footprint Calculator (Sarthak Pant, IIM L)
      </h1>
      <div class="flex flex-col md:flex-row items-center md:space-x-6">
        <a href="https://www.linkedin.com/in/sarthak-pant-2458b3142/" 
           target="_blank" 
           class="flex items-center hover:text-gray-200 transition-colors" data-aos="fade-left" data-aos-delay="50"
        >
          <i class="ri-linkedin-box-fill text-2xl mr-2"></i>
          <span>Connect on LinkedIn</span>
        </a>
        <nav class="flex space-x-4" data-aos="fade-left" data-aos-delay="100">
          <a href="/" class="flex items-center hover:text-gray-200 hover:scale-105 transform transition-all">
            <i class="ri-home-line mr-1"></i>Home
          </a>
          <a href="/scope_emissions" class="flex items-center hover:text-gray-200 hover:scale-105 transform transition-all">
            <i class="ri-bubble-chart-line mr-1"></i>Scope Emissions
          </a>
          <a href="/current_scenario" class="flex items-center hover:text-gray-200 hover:scale-105 transform transition-all">
            <i class="ri-earth-line mr-1"></i>Current Scenario
          </a>
          <a href="/calculator" class="flex items-center hover:text-gray-200 hover:scale-105 transform transition-all">
            <i class="ri-calculator-line mr-1"></i>Calculator
          </a>
        </nav>
      </div>
    </div>
  </header>

  <!-- Country & Currency Selection -->
  <div class="max-w-4xl mx-auto mt-6 px-4">
    <div class="glass-effect p-6 rounded-lg shadow-lg card-hover" data-aos="fade-up">
      <label for="country-select" class="font-bold mb-2 inline-block">
        <i class="ri-global-line mr-2"></i>Select Your Country:
      </label>
      <select
        id="country-select"
        class="border border-gray-300 rounded px-4 py-2 w-full md:w-auto focus:ring-2 focus:ring-green-500 focus:border-transparent"
        onchange="handleCountryChange()"
      >
        <option value="">--Choose--</option>
        <option value="US">United States</option>
        <option value="IN">India</option>
        <option value="GB">United Kingdom</option>
        <option value="AU">Australia</option>
        <option value="DE">Germany</option>
        <option value="CA">Canada</option>
        <option value="FR">France</option>
        <option value="BR">Brazil</option>
        <option value="JP">Japan</option>
        <option value="ZA">South Africa</option>
      </select>
      <div class="mt-4 p-3 bg-green-50 rounded-lg">
        <p class="flex items-center">
          <i class="ri-money-dollar-circle-line mr-2 text-green-600"></i>
          Your selected currency: <span id="selected-currency" class="ml-2 font-semibold text-green-600">N/A</span>
        </p>
      </div>
    </div>
  </div>

  <!-- Site Stats (Visitors + Total Site Footprint) -->
  <div class="max-w-4xl mx-auto mt-4 px-4">
    <div class="glass-effect p-6 rounded-lg shadow-lg card-hover" data-aos="fade-up" data-aos-delay="100">
      <h2 class="font-bold text-lg flex items-center text-blue-600 mb-2">
        <i class="ri-user-3-line mr-2"></i>Site Stats
      </h2>
      <p class="text-gray-700 mt-2">
        Total Visitors:
        <span class="text-green-600 ml-2 font-bold">
          {{ visitor_count }} <!-- Coming from Flask app.py -->
        </span>
      </p>
      <p class="text-gray-700 mt-1">
        Total Carbon Footprint (All Users):
        <span class="text-red-600 ml-2 font-bold">
          {{ total_site_footprint }} kg COâ‚‚/year
        </span>
      </p>
    </div>
  </div>

  <!-- OPTIONAL NEWS TICKER (Placeholder) -->
  <div class="max-w-4xl mx-auto mt-4 px-4">
    <div class="glass-effect p-6 rounded-lg shadow-lg card-hover" data-aos="fade-up" data-aos-delay="150">
      <h2 class="font-bold text-lg mb-2 flex items-center text-blue-700">
        <i class="ri-earth-line mr-2"></i> Latest Sustainability News
      </h2>
      <div id="news-ticker" class="text-green-800 font-semibold">
        <!-- Just an example placeholder. You can fetch real data via /news or an API. -->
        <span>UN warns of rising global temperatures... &bull;</span>
        <span>New local composting programs reduce waste by 30%... &bull;</span>
        <span>Major airline invests in sustainable aviation fuels... &bull;</span>
      </div>
    </div>
  </div>

  <!-- Additional block for clickable news from /news (optional) -->
  <div class="max-w-4xl mx-auto mt-4 px-4">
    <div class="glass-effect p-6 rounded-lg shadow-lg card-hover" data-aos="fade-up" data-aos-delay="180">
      <h2 class="font-bold text-lg mb-2 flex items-center text-blue-700">
        <i class="ri-earth-line mr-2"></i> More Sustainability News
      </h2>
      <!-- Container for clickable news items loaded from /news -->
      <div id="news-list" class="space-y-2"></div>
    </div>
  </div>

  <!-- 3D Pie Chart for Country's Current GHG Emissions -->
  <div class="max-w-4xl mx-auto mt-4 px-4 mb-8">
    <div class="glass-effect p-6 rounded-lg shadow-lg card-hover" data-aos="fade-up" data-aos-delay="200">
      <h2 class="font-bold text-xl mb-2 flex items-center">
        <i class="ri-pie-chart-2-line mr-2 text-purple-600"></i>
        Country's Current GHG Emissions
      </h2>
      <p class="text-sm text-gray-700 mb-4 ml-6">
        (Displays approximate % share of GHG sources; also shows net-zero target & NDC)
      </p>
      <div id="ghg-chart-container"></div>
    </div>
  </div>

  <!-- AOS Script -->
  <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
  <script>
    AOS.init({
      duration: 800,
      once: true,
      offset: 100,
      easing: 'ease-in-out'
    });

    /* 3D Earth Setup */
    async function loadOrbitControls() {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js';
        script.onload = () => {
          if (window.THREE && window.THREE.OrbitControls) {
            resolve(window.THREE.OrbitControls);
          } else {
            reject(new Error('OrbitControls failed to load'));
          }
        };
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    let renderer, scene, camera, globe, controls;
    async function init3DEarth() {
      try {
        await loadOrbitControls();
        const canvas = document.getElementById("earth-bg");
        if (!canvas) {
          console.error('Canvas element not found');
          return;
        }

        renderer = new THREE.WebGLRenderer({ 
          canvas, 
          alpha: true,
          antialias: true 
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 0, 220);

        const ambientLight = new THREE.AmbientLight(0xffffff, 1);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
        directionalLight.position.set(200, 200, 200);
        scene.add(directionalLight);

        globe = new ThreeGlobe()
          .globeImageUrl('https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg')
          .bumpImageUrl('https://unpkg.com/three-globe/example/img/earth-topology.png');

        scene.add(globe);

        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableZoom = false;
        controls.enablePan = false;
        controls.enableRotate = true;

        window.addEventListener("resize", onWindowResize, false);
        animate();
      } catch (error) {
        console.error('Error initializing 3D globe:', error);
      }
    }

    function onWindowResize() {
      if (!camera || !renderer) return;
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate() {
      if (!globe || !renderer || !scene || !camera) return;
      requestAnimationFrame(animate);
      globe.rotation.y += 0.001;
      renderer.render(scene, camera);
    }

    window.addEventListener('load', () => {
      init3DEarth().catch(console.error);
      initGHGChart();
      loadSustainabilityNews();  // Fetch /news items for clickable links

      window.addEventListener('resize', () => {
        if (chart) chart.resize();
      });
    });

    /* Country -> Currency Map */
    const countryCurrencyMap = {
      US: "USD", IN: "INR", GB: "GBP", AU: "AUD", DE: "EUR",
      CA: "CAD", FR: "EUR", BR: "BRL", JP: "JPY", ZA: "ZAR"
    };

    /* GHG Data & Net Zero Info by Country (for Pie Chart) */
    const ghgDataByCountry = {
      US: [
        { name: "Energy", value: 35 },
        { name: "Transport", value: 28 },
        { name: "Industry", value: 22 },
        { name: "Agriculture", value: 10 },
        { name: "Others", value: 5 }
      ],
      IN: [
        { name: "Energy", value: 40 },
        { name: "Transport", value: 20 },
        { name: "Industry", value: 25 },
        { name: "Agriculture", value: 12 },
        { name: "Others", value: 3 }
      ],
      GB: [
        { name: "Energy", value: 30 },
        { name: "Transport", value: 30 },
        { name: "Industry", value: 20 },
        { name: "Agriculture", value: 15 },
        { name: "Others", value: 5 }
      ],
      AU: [
        { name: "Energy", value: 45 },
        { name: "Transport", value: 25 },
        { name: "Industry", value: 20 },
        { name: "Agriculture", value: 8 },
        { name: "Others", value: 2 }
      ],
      DE: [
        { name: "Energy", value: 32 },
        { name: "Transport", value: 25 },
        { name: "Industry", value: 30 },
        { name: "Agriculture", value: 10 },
        { name: "Others", value: 3 }
      ],
      CA: [
        { name: "Energy", value: 38 },
        { name: "Transport", value: 27 },
        { name: "Industry", value: 23 },
        { name: "Agriculture", value: 9 },
        { name: "Others", value: 3 }
      ],
      FR: [
        { name: "Energy", value: 28 },
        { name: "Transport", value: 30 },
        { name: "Industry", value: 25 },
        { name: "Agriculture", value: 12 },
        { name: "Others", value: 5 }
      ],
      BR: [
        { name: "Energy", value: 35 },
        { name: "Transport", value: 20 },
        { name: "Industry", value: 18 },
        { name: "Agriculture", value: 22 },
        { name: "Others", value: 5 }
      ],
      JP: [
        { name: "Energy", value: 40 },
        { name: "Transport", value: 28 },
        { name: "Industry", value: 22 },
        { name: "Agriculture", value: 8 },
        { name: "Others", value: 2 }
      ],
      ZA: [
        { name: "Energy", value: 50 },
        { name: "Transport", value: 20 },
        { name: "Industry", value: 20 },
        { name: "Agriculture", value: 8 },
        { name: "Others", value: 2 }
      ]
    };

    const countryInfo = {
      US: {
        netZeroTarget: "2050",
        ndc: "50-52% reduction by 2030 (vs. 2005)"
      },
      IN: {
        netZeroTarget: "2070",
        ndc: "45% emission intensity reduction by 2030 (vs. 2005)"
      },
      GB: {
        netZeroTarget: "2050",
        ndc: "At least 68% reduction by 2030 (vs. 1990)"
      },
      AU: {
        netZeroTarget: "2050",
        ndc: "43% reduction by 2030 (vs. 2005)"
      },
      DE: {
        netZeroTarget: "2045",
        ndc: "65% reduction by 2030 (vs. 1990)"
      },
      CA: {
        netZeroTarget: "2050",
        ndc: "40-45% reduction by 2030 (vs. 2005)"
      },
      FR: {
        netZeroTarget: "2050",
        ndc: "55% reduction by 2030 (vs. 1990)"
      },
      BR: {
        netZeroTarget: "2050",
        ndc: "50% reduction by 2030 (vs. 2005)"
      },
      JP: {
        netZeroTarget: "2050",
        ndc: "46% reduction by 2030 (vs. 2013)"
      },
      ZA: {
        netZeroTarget: "2050",
        ndc: "34% reduction by 2030 (vs. 2015)"
      }
    };

    function handleCountryChange() {
      const select = document.getElementById("country-select");
      const currencySpan = document.getElementById("selected-currency");
      const selectedCountryCode = select.value;
      currencySpan.classList.add('animate-pulse');
      setTimeout(() => {
        if (selectedCountryCode && countryCurrencyMap[selectedCountryCode]) {
          currencySpan.textContent = countryCurrencyMap[selectedCountryCode];
        } else {
          currencySpan.textContent = "N/A";
        }
        currencySpan.classList.remove('animate-pulse');
      }, 300);
      updateGHGChart(selectedCountryCode);
    }

    let chart;
    function initGHGChart() {
      const chartDom = document.getElementById("ghg-chart-container");
      if (!chartDom) return;
      chart = echarts.init(chartDom);

      const option = {
        title: {
          text: 'GHG Emissions (No Country Selected)',
          left: 'center',
          top: 20,
          textStyle: {
            fontSize: 16
          }
        },
        tooltip: {
          trigger: 'item',
          formatter: '{a} <br/>{b} : {c}%'
        },
        legend: {
          orient: 'vertical',
          left: 'left',
          top: 'middle'
        },
        series: [
          {
            name: 'Emissions Share',
            type: 'pie',
            radius: '50%',
            center: ['50%', '60%'],
            data: [
              { value: 0, name: 'Energy' },
              { value: 0, name: 'Transport' },
              { value: 0, name: 'Industry' },
              { value: 0, name: 'Agriculture' },
              { value: 0, name: 'Others' }
            ],
            emphasis: {
              itemStyle: {
                shadowBlur: 10,
                shadowOffsetX: 0,
                shadowColor: 'rgba(0, 0, 0, 0.5)'
              }
            }
          }
        ]
      };
      chart.setOption(option);
    }

    function updateGHGChart(countryCode) {
      if (!chart) return;
      const data = ghgDataByCountry[countryCode];
      const info = countryInfo[countryCode];

      if (!data) {
        chart.setOption({
          title: { text: 'GHG Emissions (No Country Selected)' },
          series: [{
            data: [
              { value: 0, name: 'Energy' },
              { value: 0, name: 'Transport' },
              { value: 0, name: 'Industry' },
              { value: 0, name: 'Agriculture' },
              { value: 0, name: 'Others' }
            ]
          }]
        });
        return;
      }

      chart.setOption({
        title: {
          text: `GHG Emissions in ${countryCode}\nNet Zero Target: ${info.netZeroTarget}\nNDC: ${info.ndc}`,
          textStyle: {
            fontSize: 14,
            lineHeight: 24
          }
        },
        series: [{
          data: data.map(item => ({
            name: item.name,
            value: item.value,
            itemStyle: {
              color: {
                'Energy': '#ff7675',
                'Transport': '#74b9ff',
                'Industry': '#55efc4',
                'Agriculture': '#ffeaa7',
                'Others': '#b2bec3'
              }[item.name]
            }
          }))
        }]
      });
    }

    /* ==================== Chatbot UI (unchanged) ==================== */
    const messagesDiv = document.getElementById("messages");
    const userInput = document.getElementById("userInput");
    const sendBtn = document.getElementById("sendBtn");

    sendBtn.addEventListener("click", async () => {
      const text = userInput.value.trim();
      if (!text) return;

      // Display user message
      const userMsgDiv = document.createElement("div");
      userMsgDiv.className = "mb-2 text-blue-800";
      userMsgDiv.innerHTML = `<strong>You:</strong> ${text}`;
      messagesDiv.appendChild(userMsgDiv);

      // Send to server
      try {
        const response = await fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: "message=" + encodeURIComponent(text)
        });
        const data = await response.json();

        const botMsgDiv = document.createElement("div");
        botMsgDiv.className = "mb-2 text-green-700";
        botMsgDiv.innerHTML = `<strong>Bot:</strong> ${data.response}`;
        messagesDiv.appendChild(botMsgDiv);

      } catch (err) {
        console.error("Chat error:", err);
      }

      // Clear input
      userInput.value = "";
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });

    userInput.addEventListener("keyup", (e) => {
      if (e.key === "Enter") {
        sendBtn.click();
      }
    });

    /* ==================== Fetch Additional Sustainability News from /news ==================== */
    async function loadSustainabilityNews() {
      try {
        const res = await fetch("/news");
        const newsData = await res.json();
        const newsList = document.getElementById("news-list");
        newsList.innerHTML = ""; // clear existing

        newsData.forEach(item => {
          const linkEl = document.createElement("a");
          linkEl.href = item.link;
          linkEl.target = "_blank";
          linkEl.textContent = item.title;
          linkEl.className = "block text-green-800 hover:underline";
          newsList.appendChild(linkEl);
        });
      } catch (error) {
        console.error("Error loading sustainability news:", error);
      }
    }
  </script>
</body>
</html>
