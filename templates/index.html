<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carbon Footprint Calculator (Sarthak Pant, IIM L)</title>
  
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet" />
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://unpkg.com/three-globe/dist/three-globe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts-gl/dist/echarts-gl.min.js"></script>

  <style>
    /* 3D Earth background, faded */
    #earth-bg {
      position: fixed;
      top: 0;
      left: 0;
      z-index: -1;
      opacity: 0.3;
      width: 100%;
      height: 100%;
    }
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow-x: hidden;
    }
    canvas {
      display: block;
      width: 100%;
      height: 100%;
    }
    .card-hover {
      transition: all 0.3s ease;
    }
    .card-hover:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }
    .glass-effect {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    /* News ticker (placeholder) */
    #news-ticker {
      overflow: hidden;
      white-space: nowrap;
    }
    #news-ticker span {
      display: inline-block;
      padding-right: 2rem;
      animation: ticker 25s linear infinite;
    }
    @keyframes ticker {
      0% { transform: translateX(100%); }
      100% { transform: translateX(-100%); }
    }
    /* Chart containers */
    #ghg-chart-container,
    #ndc-chart-container,
    #scope-chart-container {
      width: 100%;
      height: 400px;
      margin-top: 2rem;
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }
    #ghg-chart-container:hover,
    #ndc-chart-container:hover,
    #scope-chart-container:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }
  </style>
</head>

<body class="bg-gray-100">
  <canvas id="earth-bg"></canvas>

  <!-- HEADER -->
  <header class="bg-green-600 bg-opacity-95 text-white p-4 sticky top-0 z-50 shadow-lg">
    <div class="max-w-7xl mx-auto px-4 flex flex-col md:flex-row justify-between items-center">
      <h1 class="text-2xl font-bold mb-2 md:mb-0" data-aos="fade-right">
        Carbon Footprint Calculator (Sarthak Pant, IIM L)
      </h1>
      <div class="flex flex-col md:flex-row items-center md:space-x-6">
        <a href="https://www.linkedin.com/in/sarthak-pant-2458b3142/" 
           target="_blank" 
           class="flex items-center hover:text-gray-200 transition-colors" data-aos="fade-left" data-aos-delay="50"
        >
          <i class="ri-linkedin-box-fill text-2xl mr-2"></i>
          <span>Connect on LinkedIn</span>
        </a>
        <nav class="flex space-x-4" data-aos="fade-left" data-aos-delay="100">
          <a href="/" class="flex items-center hover:text-gray-200 hover:scale-105 transform transition-all">
            <i class="ri-home-line mr-1"></i>Home
          </a>
          <a href="/scope_emissions" class="flex items-center hover:text-gray-200 hover:scale-105 transform transition-all">
            <i class="ri-bubble-chart-line mr-1"></i>Scope Emissions
          </a>
          <a href="/current_scenario" class="flex items-center hover:text-gray-200 hover:scale-105 transform transition-all">
            <i class="ri-earth-line mr-1"></i>Current Scenario
          </a>
          <a href="/calculator" class="flex items-center hover:text-gray-200 hover:scale-105 transform transition-all">
            <i class="ri-calculator-line mr-1"></i>Calculator
          </a>
        </nav>
      </div>
    </div>
  </header>

  <!-- Example: site stats or country & currency selection blocks ... -->
  <!-- (Omitted for brevity, or re-add your code for visitor count, total footprint, etc.) -->

  <!-- News Ticker (Placeholder) -->
  <div class="max-w-4xl mx-auto mt-6 px-4">
    <div class="glass-effect p-6 rounded-lg shadow-lg card-hover">
      <h2 class="text-lg font-bold text-blue-700 mb-2 flex items-center">
        <i class="ri-earth-line mr-2"></i>Latest Sustainability News
      </h2>
      <div id="news-ticker" class="text-green-800 font-semibold">
        <span>UN warns of rising global temperatures... &bull;</span>
        <span>Local composting reduces waste 30%... &bull;</span>
        <span>Major airline invests in sustainable aviation fuels... &bull;</span>
      </div>
    </div>
  </div>

  <!-- 1) GHG Emissions Pie Chart (Country-Specific) -->
  <div class="max-w-4xl mx-auto mt-6 px-4">
    <div class="glass-effect p-6 rounded-lg shadow-lg card-hover">
      <h2 class="font-bold text-xl mb-2 flex items-center">
        <i class="ri-pie-chart-2-line mr-2 text-purple-600"></i>
        Country's Current GHG Emissions
      </h2>
      <p class="text-sm text-gray-700 mb-4 ml-6">
        Select a country (above) to see approximate % share of GHG sources, net-zero target, etc.
      </p>
      <div id="ghg-chart-container"></div>
    </div>
  </div>

  <!-- 2) NDC Pie Chart (All Countries in One Chart) -->
  <div class="max-w-4xl mx-auto mt-6 px-4">
    <div class="glass-effect p-6 rounded-lg shadow-lg card-hover">
      <h2 class="font-bold text-xl mb-2 flex items-center">
        <i class="ri-pie-chart-fill mr-2 text-blue-600"></i>
        All Countries NDC (Emission Reduction %)
      </h2>
      <p class="text-sm text-gray-700 mb-4 ml-6">
        Each slice shows the pledged emission reduction by 2030.
      </p>
      <div id="ndc-chart-container"></div>
    </div>
  </div>

  <!-- 3) Scope Emissions (All Countries) -->
  <div class="max-w-4xl mx-auto mt-6 px-4 mb-8">
    <div class="glass-effect p-6 rounded-lg shadow-lg card-hover">
      <h2 class="font-bold text-xl mb-2 flex items-center">
        <i class="ri-bubble-chart-line mr-2 text-green-600"></i>
        Scope Emissions by Country
      </h2>
      <p class="text-sm text-gray-700 mb-4 ml-6">
        Approximate Scope 1, 2, or 3 coverage (demo).
      </p>
      <div id="scope-chart-container"></div>
    </div>
  </div>

  <!-- Chatbot UI (if you still want it) -->
  <div class="max-w-4xl mx-auto px-4 mb-8">
    <div class="p-6 bg-white rounded-lg shadow-lg" id="chatbot-card">
      <h2 class="text-2xl font-bold mb-4 flex items-center">
        <i class="ri-robot-fill text-3xl text-green-600 mr-3"></i>
        Carbon Calculator AI Bot
      </h2>
      <p class="text-sm text-gray-600 mb-2">Type "start" to do a guided flow, or just ask me any question!</p>
      <div
        id="messages"
        class="border border-gray-300 p-4 h-64 overflow-y-auto mb-4 bg-gray-50 rounded"
      >
        <div class="mb-2 text-gray-600">
          <strong>Bot:</strong> Hello! Ask me about carbon footprints or your activities.
        </div>
      </div>
      <div class="flex">
        <input 
          id="userInput" 
          type="text" 
          placeholder="Type your question..."
          class="flex-1 border border-gray-300 rounded-l px-4 py-2 focus:outline-none" 
        />
        <button 
          id="sendBtn" 
          class="bg-green-600 text-white px-6 py-2 rounded-r hover:bg-green-700 transition-colors"
        >
          Send
        </button>
      </div>
    </div>
  </div>

  <!-- AOS JS -->
  <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
  <script>
    AOS.init({
      duration: 800,
      once: true,
      offset: 100,
      easing: 'ease-in-out'
    });

    /*******************************************************
     * 3D Earth Setup
     *******************************************************/
    let renderer, scene, camera, globe, controls;

    async function loadOrbitControls() {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js';
        script.onload = () => {
          if (window.THREE && window.THREE.OrbitControls) {
            resolve(window.THREE.OrbitControls);
          } else {
            reject(new Error('OrbitControls failed to load'));
          }
        };
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    async function init3DEarth() {
      try {
        await loadOrbitControls();
        const canvas = document.getElementById("earth-bg");
        if (!canvas) return;

        renderer = new THREE.WebGLRenderer({ 
          canvas, 
          alpha: true,
          antialias: true 
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 0, 220);

        const ambientLight = new THREE.AmbientLight(0xffffff, 1);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
        directionalLight.position.set(200, 200, 200);
        scene.add(directionalLight);

        globe = new ThreeGlobe()
          .globeImageUrl('https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg')
          .bumpImageUrl('https://unpkg.com/three-globe/example/img/earth-topology.png');

        scene.add(globe);

        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableZoom = false;
        controls.enablePan = false;
        controls.enableRotate = true;

        window.addEventListener("resize", onWindowResize, false);
        animate();
      } catch (error) {
        console.error('Error initializing 3D globe:', error);
      }
    }

    function onWindowResize() {
      if (!camera || !renderer) return;
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate() {
      if (!globe || !renderer || !scene || !camera) return;
      requestAnimationFrame(animate);
      globe.rotation.y += 0.001;
      renderer.render(scene, camera);
    }

    /*******************************************************
     * 1) GHG Emissions Chart (Per Country)
     *******************************************************/
    let chart; // existing GHG chart

    // Pre-defined data for GHG + net-zero
    const ghgDataByCountry = {
      US: [
        { name: "Energy", value: 35 },
        { name: "Transport", value: 28 },
        { name: "Industry", value: 22 },
        { name: "Agriculture", value: 10 },
        { name: "Others", value: 5 }
      ],
      IN: [
        { name: "Energy", value: 40 },
        { name: "Transport", value: 20 },
        { name: "Industry", value: 25 },
        { name: "Agriculture", value: 12 },
        { name: "Others", value: 3 }
      ],
      GB: [
        { name: "Energy", value: 30 },
        { name: "Transport", value: 30 },
        { name: "Industry", value: 20 },
        { name: "Agriculture", value: 15 },
        { name: "Others", value: 5 }
      ],
      // ... etc. for other countries ...
    };

    const countryInfo = {
      US: {
        netZeroTarget: "2050",
        ndc: "50-52% reduction by 2030"
      },
      IN: {
        netZeroTarget: "2070",
        ndc: "45% reduction by 2030"
      },
      GB: {
        netZeroTarget: "2050",
        ndc: "At least 68% by 2030"
      },
      // ...
    };

    function initGHGChart() {
      const chartDom = document.getElementById("ghg-chart-container");
      if (!chartDom) return;

      chart = echarts.init(chartDom);

      // Default (no country selected)
      const option = {
        title: {
          text: 'GHG Emissions (No Country Selected)',
          left: 'center',
          top: 20,
          textStyle: { fontSize: 16 }
        },
        tooltip: {
          trigger: 'item',
          formatter: '{a} <br/>{b} : {c}%'
        },
        legend: {
          orient: 'vertical',
          left: 'left',
          top: 'middle'
        },
        series: [
          {
            name: 'Emissions Share',
            type: 'pie',
            radius: '50%',
            center: ['50%', '60%'],
            data: [
              { value: 0, name: 'Energy' },
              { value: 0, name: 'Transport' },
              { value: 0, name: 'Industry' },
              { value: 0, name: 'Agriculture' },
              { value: 0, name: 'Others' }
            ]
          }
        ]
      };
      chart.setOption(option);
    }

    // Update GHG Chart when user changes country
    function updateGHGChart(countryCode) {
      if (!chart) return;
      const data = ghgDataByCountry[countryCode];
      const info = countryInfo[countryCode];
      if (!data) {
        // no data
        chart.setOption({
          title: { text: 'GHG Emissions (No Country Selected)' },
          series: [{ data: [] }]
        });
        return;
      }

      chart.setOption({
        title: {
          text: `GHG Emissions in ${countryCode}\nNet Zero Target: ${info.netZeroTarget}\nNDC: ${info.ndc}`
        },
        series: [{
          data: data.map(item => ({
            name: item.name,
            value: item.value,
            itemStyle: {
              color: {
                'Energy': '#ff7675',
                'Transport': '#74b9ff',
                'Industry': '#55efc4',
                'Agriculture': '#ffeaa7',
                'Others': '#b2bec3'
              }[item.name]
            }
          }))
        }]
      });
    }

    // Called on <select> change
    function handleCountryChange() {
      const select = document.getElementById("country-select");
      const selectedCountry = select.value;
      updateGHGChart(selectedCountry);

      // optional: update currency label
      const currencySpan = document.getElementById("selected-currency");
      currencySpan.classList.add('animate-pulse');
      setTimeout(() => {
        currencySpan.textContent = countryCurrencyMap[selectedCountry] || "N/A";
        currencySpan.classList.remove('animate-pulse');
      }, 300);
    }

    /*******************************************************
     * 2) NDC Pie Chart (All Countries)
     *******************************************************/
    // e.g. each country's pledged % for 2030
    const ndcAllCountries = [
      { name: "US", value: 50 },  // 50% by 2030
      { name: "IN", value: 45 },
      { name: "GB", value: 68 },
      { name: "AU", value: 43 },
      { name: "DE", value: 65 },
      { name: "CA", value: 40 },
      { name: "FR", value: 55 },
      { name: "BR", value: 50 },
      { name: "JP", value: 46 },
      { name: "ZA", value: 34 }
    ];

    let ndcChart;
    function initNDCChart() {
      const ndcDom = document.getElementById("ndc-chart-container");
      if (!ndcDom) return;

      ndcChart = echarts.init(ndcDom);

      const option = {
        title: {
          text: 'All Countries NDC',
          left: 'center'
        },
        tooltip: {
          trigger: 'item',
          formatter: '{b}: {c}%'
        },
        legend: {
          orient: 'vertical',
          left: 'left'
        },
        series: [{
          name: 'NDC',
          type: 'pie',
          radius: '50%',
          center: ['50%', '50%'],
          data: ndcAllCountries.map(item => ({
            name: item.name + ` (${item.value}%)`,
            value: item.value
          }))
        }]
      };

      ndcChart.setOption(option);
    }

    /*******************************************************
     * 3) Scope Emissions (All Countries in One Chart)
     *******************************************************/
    // Suppose we do a simple example: each country has a "scope" value
    // or we do a breakdown of scope 1,2,3. We'll do single slice per country.
    const scopeAllCountries = [
      { name: "US (Scope 1/2/3)", value: 200 },
      { name: "IN (Scope 1/2/3)", value: 150 },
      { name: "GB (Scope 1/2/3)", value: 180 },
      { name: "AU (Scope 1/2/3)", value: 120 },
      { name: "DE (Scope 1/2/3)", value: 200 },
      { name: "CA (Scope 1/2/3)", value: 130 },
      { name: "FR (Scope 1/2/3)", value: 140 },
      { name: "BR (Scope 1/2/3)", value: 110 },
      { name: "JP (Scope 1/2/3)", value: 190 },
      { name: "ZA (Scope 1/2/3)", value: 100 }
    ];

    let scopeChart;
    function initScopeChart() {
      const scopeDom = document.getElementById("scope-chart-container");
      if (!scopeDom) return;

      scopeChart = echarts.init(scopeDom);

      const option = {
        title: {
          text: 'Scope Emissions (All Countries)',
          left: 'center'
        },
        tooltip: {
          trigger: 'item',
          formatter: '{b}: {c}'
        },
        legend: {
          orient: 'vertical',
          left: 'left'
        },
        series: [{
          name: 'Scope',
          type: 'pie',
          radius: '50%',
          center: ['50%', '50%'],
          data: scopeAllCountries
        }]
      };
      scopeChart.setOption(option);
    }

    /*******************************************************
     * On Window Load
     *******************************************************/
    window.addEventListener("load", () => {
      // Initialize Earth
      init3DEarth().catch(console.error);

      // Initialize the GHG chart (per country)
      initGHGChart();
      // Initialize the NDC chart (all countries in one pie)
      initNDCChart();
      // Initialize scope chart (all countries in one pie)
      initScopeChart();

      // Resize handling
      window.addEventListener('resize', () => {
        if (chart) chart.resize();       // GHG chart
        if (ndcChart) ndcChart.resize(); // NDC chart
        if (scopeChart) scopeChart.resize(); // scope chart
      });
    });

    /*******************************************************
     * Chatbot + Misc
     *******************************************************/
    const messagesDiv = document.getElementById("messages");
    const userInput = document.getElementById("userInput");
    const sendBtn = document.getElementById("sendBtn");

    sendBtn.addEventListener("click", async () => {
      const text = userInput.value.trim();
      if (!text) return;

      // Display user message
      const userMsgDiv = document.createElement("div");
      userMsgDiv.className = "mb-2 text-blue-800";
      userMsgDiv.innerHTML = `<strong>You:</strong> ${text}`;
      messagesDiv.appendChild(userMsgDiv);

      // Send to server
      try {
        const response = await fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: "message=" + encodeURIComponent(text)
        });
        const data = await response.json();

        const botMsgDiv = document.createElement("div");
        botMsgDiv.className = "mb-2 text-green-700";
        botMsgDiv.innerHTML = `<strong>Bot:</strong> ${data.response}`;
        messagesDiv.appendChild(botMsgDiv);

      } catch (err) {
        console.error("Chat error:", err);
      }

      // Clear input
      userInput.value = "";
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });

    userInput.addEventListener("keyup", (e) => {
      if (e.key === "Enter") {
        sendBtn.click();
      }
    });
  </script>
</body>
</html>
